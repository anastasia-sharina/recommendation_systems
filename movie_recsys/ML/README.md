# ML сервис рекомендательной системы

## Описание

ML-сервис реализует классическую рекомендательную систему для социальных постов. В основе лежит модель CatBoost, обученная на пользовательских и постовых признаках, включая текстовые эмбеддинги, категориальные и временные фичи, а также кластерные признаки. Сервис предоставляет API для получения персональных рекомендаций через FastAPI.

## Этапы пайплайна

1. **Загрузка и анализ данных**  
   - Импорт и очистка данных из PostgreSQL через общий модуль `common/db_connect.py`.
   - Анализ структуры данных, обработка пропусков, создание новых признаков.

2. **Формирование признаков**  
   - TF-IDF преобразование текстов, лемматизация с NLTK.
   - Снижение размерности (PCA), кластеризация (KMeans), добавление кластерных расстояний.
   - Генерация временных признаков (`hour`, `month`), обработка категориальных признаков (OneHot, TargetEncoder).

3. **Обучение моделей**  
   - Базовый DecisionTree для сравнения.
   - Основная модель CatBoost: подбор параметров, обучение на категориальных и числовых фичах.

4. **Оценка качества**  
   - Основная метрика: ROC-AUC (train/test).
   - Визуализация важности признаков.
   - Пример качества:
     - CatBoost ROC-AUC (train): ~0.77
     - CatBoost ROC-AUC (test): ~0.76

5. **Сохранение модели**  
   - Модель сохраняется в формате `.cbm` для дальнейшего использования в сервисе.

6. **API сервис**  
   - Реализация FastAPI для онлайн-рекомендаций.
   - Эндпоинт `/post/recommendations/` возвращает топ-N постов для пользователя на основе обученной модели.

## Полный стек технологий

- **Python 3.8+**
- **CatBoost**
- **scikit-learn**
- **NLTK**
- **Pandas, NumPy**
- **FastAPI**
- **SQLAlchemy**
- **PostgreSQL**
- **Docker**
- **Seaborn, Matplotlib (анализ признаков)**

## Метрики качества

- **ROC-AUC** — основная метрика для оценки ранжирования.
- **Hitrate** — используется для финальной проверки в LMS.
- **Feature Importance** — анализ важности признаков модели.

## Как запустить

### Локально

1. Установить зависимости:
    ```bash
    pip install -r ../common/requirements.txt
    ```

2. Запустить сервис:
    ```bash
    python service_ml.py
    ```

### Через Docker

```bash
docker build -t ml-dl-ab --build-arg PROJECT=ml --build-arg SERVICE_FILE=service_ml.py .
docker run --env-file ../common/.env -p 8000:8000 ml-dl-ab
```

## Пример запроса к API

```python
import requests
r = requests.get("http://localhost:8000/post/recommendations/", params={"id": 1000, "time": "2021-12-20T00:00:00", "limit": 5})
print(r.json())
```

## Тестирование

- Юнит-тесты для сервиса лежат в `test_ml.py`.
- Для проверки API используйте FastAPI TestClient или curl.

## Контакты

Автор: Анастасия Шарина  
GitHub: [anastasia-sharina](https://github.com/anastasia-sharina)